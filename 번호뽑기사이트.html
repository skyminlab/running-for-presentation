<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∞úÌëú Î™®Îë† Ï†ïÌïòÍ∏∞ - Ïö¥ÎèôÌöå Í≥µÍµ¥Î¶¨Í∏∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Materialize CSS (for structure/components) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        .font-michroma { font-family: 'Noto Sans KR', 'Noto Sans', sans-serif; }
        .bg-gradient-radial {
            background: radial-gradient(circle, var(--tw-gradient-stops));
        }
        .glow-border {
            position: relative;
        }
        .glow-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, rgba(255,255,255,0.8), rgba(255,255,255,0.2), rgba(255,255,255,0.8));
            border-radius: inherit;
            z-index: -1;
            filter: blur(1px);
        }
        .glow-border-white {
            position: relative;
        }
        .glow-border-white::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, rgba(255,255,255,0.6), rgba(255,255,255,0.1), rgba(255,255,255,0.6));
            border-radius: inherit;
            z-index: -1;
            filter: blur(0.5px);
        }
        .embossed {
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.8),
                inset 0 -1px 0 rgba(0,0,0,0.1),
                0 1px 2px rgba(0,0,0,0.1);
        }
        .embossed-button {
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.9),
                inset 0 -1px 0 rgba(0,0,0,0.2),
                0 1px 3px rgba(0,0,0,0.15);
        }
        .neon-button-primary {
            background: radial-gradient(ellipse at top, #ffffff, #f8fafc, #e2e8f0);
            box-shadow: 
                0 0 20px rgba(255,255,255,0.4),
                0 0 40px rgba(255,255,255,0.2),
                inset 0 1px 0 rgba(255,255,255,0.6),
                inset 0 -1px 0 rgba(0,0,0,0.1);
        }
        .neon-button-secondary {
            background: radial-gradient(ellipse at bottom, #3b82f6, #1d4ed8, #1e40af);
            box-shadow: 
                0 0 20px rgba(59, 130, 246, 0.5),
                0 0 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.3),
                inset 0 -1px 0 rgba(0,0,0,0.2);
        }
        .button-bg {
            position: relative;
        }
        .button-bg::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.1), transparent);
            border-radius: inherit;
            z-index: -1;
            filter: blur(10px);
        }
        .card-animate {
            opacity: 0;
            transform: translateY(50px) scale(0.9);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .card-animate.animate-in {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .card-1 { transition-delay: 0.1s; }
        .card-2 { transition-delay: 0.2s; }
        .card-3 { transition-delay: 0.3s; }
        .card-4 { transition-delay: 0.4s; }
        .card-5 { transition-delay: 0.5s; }
        .card-6 { transition-delay: 0.6s; }
        .card-7 { transition-delay: 0.7s; }
        .card-8 { transition-delay: 0.8s; }
        .card-9 { transition-delay: 0.9s; }
        .card-10 { transition-delay: 1.0s; }
        .card-11 { transition-delay: 1.1s; }
        .card-12 { transition-delay: 1.2s; }
        
        /* Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .loading-element {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .loading-element.animate-in {
            opacity: 1;
            transform: translateY(0);
        }
        .loading-navbar { transition-delay: 0.2s; }
        .loading-badges { transition-delay: 0.4s; }
        .loading-title { transition-delay: 0.6s; }
        .loading-description { transition-delay: 0.8s; }
        .loading-buttons { transition-delay: 1.0s; }
        
        /* Ï≤´ Î≤àÏß∏ Î≤ÑÌäº Ï∞®Ïò§Î•¥Îäî Ìö®Í≥º */
        .fill-button {
            position: relative;
            overflow: hidden;
            background: transparent;
            border: 2px solid white;
            color: white;
        }
        .fill-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: white;
            transition: left 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: -1;
        }
        .fill-button.animate-fill::before {
            left: 0;
        }
        .fill-button.animate-fill {
            color: #1e40af;
            transition: color 0.3s ease 0.9s;
        }
        
        /* 3D ÌîåÎ¶Ω Ìö®Í≥º */
        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: inherit;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        /* Materialize tone overrides to match master.html (dark, soft, no hover) */
        body {
            color: #ffffff;
        }
        .container {
            max-width: 1120px;
        }
        /* Soft Neo‚ÄëBrutalism panels */
        .card.dark-card {
            background: #0b1220;
            border: 2px solid rgba(255,255,255,0.28);
            border-radius: 20px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.45);
        }
        .card-title {
            font-weight: 400;
            letter-spacing: 0.02em;
        }
        .btn, .btn-large, .btn-small {
            border-radius: 20px;
            text-transform: none;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.45);
            background: #e5e7eb;
            border: 2px solid #111827;
            color: #111827 !important;
        }
        .btn:hover, .btn:focus, .btn:active {
            background: #e5e7eb;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.45);
            filter: none;
        }
        .btn-secondary {
            background: #2563eb;
            color: #ffffff !important;
            border-radius: 20px;
            border: 2px solid #0b1220;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.45);
        }
        .btn-secondary:hover, .btn-secondary:focus, .btn-secondary:active {
            background: #2563eb;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.45);
            filter: none;
        }
        a:hover, a:focus {
            text-decoration: none;
            filter: none;
        }
        .chip {
            background: #0b1220;
            border: 2px solid rgba(255,255,255,0.28);
            color: #e5e7eb;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.45);
        }
        /* Track & ball (sports-day rolling) */
        .track {
            position: relative;
            height: 32px;
            border-radius: 16px;
            /* rubbery athletics track look */
            background:
                radial-gradient(circle at 2px 2px, rgba(255,255,255,0.08) 1px, transparent 1px) 0 0/6px 6px,
                #c24a2f;
            border: 2px solid #ffffff;
            overflow: hidden;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.25);
        }
        /* lane separators (white lines like a track) */
        .lane {
            border-top: 4px solid #ffffff;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        .lane:last-child {
            border-bottom: 4px solid #ffffff;
        }
        .lane-num {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-size: 26px;
            font-weight: 700;
            color: #ffffff;
            opacity: 0.9;
            letter-spacing: 2px;
            pointer-events: none;
            text-shadow: 0 0 2px rgba(0,0,0,0.25);
        }
        .finish {
            position: absolute;
            right: 10px;
            top: 0;
            bottom: 0;
            width: 8px;
            background: repeating-linear-gradient(45deg, #ffffff 0 8px, rgba(255,255,255,0) 8px 16px);
            opacity: 0.85;
        }
        /* winner emphasis */
        .lane.winner .ball {
            width: 56px;
            height: 56px;
            background: #facc15; /* gold */
            border: 3px solid #ffffff;
            animation: winnerPulse 600ms ease-in-out infinite alternate;
        }
        .lane.winner .track {
            box-shadow: inset 0 0 0 4px rgba(255,255,255,0.7);
        }
        @keyframes winnerPulse {
            from { transform: translate(-50%, -50%) scale(1.0); }
            to   { transform: translate(-50%, -50%) scale(1.15); }
        }
        .track-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: #3b82f6;
            transition: width 60ms linear;
        }
        .ball {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fde047; /* yellow */
            border: 2px solid #111827;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.45);
        }
        .muted {
            color: rgba(255,255,255,0.7);
        }
        /* Stadium background for race area */
        .stadium {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: repeating-linear-gradient(135deg, #0b1220 0 24px, #0e1629 24px 48px);
            min-height: 420px;
        }
        .stadium::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25));
            pointer-events: none;
        }
        .stadium-content {
            position: relative;
            z-index: 1;
            padding: 16px;
        }
        .lane {
            display: grid;
            grid-template-columns: 56px 1fr 140px;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        /* Animal sprite pushing the ball */
        .animal {
            position: absolute;
            top: 50%;
            transform: translate(-70%, -50%); /* slightly behind the ball */
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: #0b1220;
            border: 2px solid rgba(255,255,255,0.28);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .animal img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        /* Stadium bunting (flags) */
        .bunting {
            position: absolute;
            top: 10px;
            left: 14px;
            display: flex;
            gap: 10px;
            z-index: 2;
        }
        .flag {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 16px solid #2563eb; /* blue */
            transform: rotate(-8deg);
        }
        .flag:nth-child(2) { border-bottom-color: #10b981; transform: rotate(5deg); }
        .flag:nth-child(3) { border-bottom-color: #f59e0b; transform: rotate(-3deg); }
        .flag:nth-child(4) { border-bottom-color: #ef4444; transform: rotate(7deg); }
        .flag:nth-child(5) { border-bottom-color: #a855f7; transform: rotate(-6deg); }
        /* Winner banner */
        #winnerBanner {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            background: rgba(0,0,0,0.45);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .winner-card {
            position: relative;
            background: #0b1220;
            border: 4px solid #ffffff;
            border-radius: 28px;
            padding: 36px 40px;
            text-align: center;
            color: #e5e7eb;
            box-shadow: 12px 12px 0 rgba(0,0,0,0.65);
            transform: scale(0.9);
            width: min(90vw, 720px);
            animation: pop 280ms ease-out forwards;
        }
        .winner-card::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: inherit;
            background: conic-gradient(#60a5fa, #f59e0b, #f472b6, #34d399, #60a5fa);
            filter: blur(10px);
            z-index: -1;
            animation: spin 6s linear infinite;
        }
        .winner-title {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .winner-sub {
            font-size: 20px;
            opacity: 0.95;
        }
        .winner-trophy {
            font-size: 64px;
            margin-bottom: 8px;
        }
        @keyframes pop {
            to { transform: scale(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* simple confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 14px;
            top: -20px;
            left: 50%;
            opacity: 0.95;
            transform: translateX(-50%);
            animation: fall 1800ms linear forwards;
            border-radius: 2px;
        }
        @keyframes fall {
            0% { transform: translate(-50%, -20px) rotate(0deg); }
            100% { transform: translate(-50%, 100vh) rotate(540deg); }
        }
        /* Responsive tweaks for mobile & tablets */
        @media (max-width: 1024px) {
            .stadium { min-height: 360px; }
            .lane { grid-template-columns: 52px 1fr 120px; }
            .track { height: 30px; }
        }
        @media (max-width: 600px) {
            body.p-16 { padding: 12px !important; }
            .stadium-content { padding: 12px; }
            .stadium { min-height: 320px; }
            .lane { grid-template-columns: 44px 1fr 96px; gap: 8px; }
            .track { height: 28px; }
            .ball { width: 32px; height: 32px; }
            .animal { width: 32px; height: 32px; border-radius: 10px; }
            .lane-num { font-size: 18px; left: 6px; }
            .winner-card { width: min(94vw, 560px); padding: 28px 24px; }
            .winner-title { font-size: 32px; }
            .winner-sub { font-size: 18px; }
            .winner-trophy { font-size: 48px; }
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #0b1220;
            border: 2px solid rgba(255,255,255,0.28);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.45);
            color: #fff;
        }
    </style>
</head>
<body class="min-h-screen p-16 font-michroma relative overflow-hidden">
    <!-- ÌéòÏù¥ÏßÄ Î∞∞Í≤Ω ÏõêÌòï Í∑∏ÎùºÎîîÏñ∏Ìä∏ -->
    <div class="fixed inset-0 -z-10">
        <div class="absolute top-0 left-0 w-[800px] h-[800px] bg-gradient-radial from-blue-400/30 to-transparent rounded-full blur-3xl"></div>
        <div class="absolute top-1/2 right-0 w-[600px] h-[600px] bg-gradient-radial from-blue-500/25 to-transparent rounded-full blur-2xl"></div>
        <div class="absolute bottom-0 left-1/3 w-[700px] h-[700px] bg-gradient-radial from-blue-300/20 to-transparent rounded-full blur-3xl"></div>
        <div class="absolute inset-0 bg-black"></div>
        </div>

    <div class="container" style="padding-top: 32px; padding-bottom: 48px;">
        <div class="row">
            <div class="col s12">
                <div class="card dark-card">
                    <div class="card-content">
                        <span class="card-title" style="font-size: 28px; color: #e5e7eb;">Î∞úÌëú Î™®Îë† Ï†ïÌïòÍ∏∞ - Ïö¥ÎèôÌöå Í≥µÍµ¥Î¶¨Í∏∞</span>
                        <p class="muted" style="margin-top: 8px;">Î™®Îë†Î≥Ñ Ï∫êÎ¶≠ÌÑ∞Í∞Ä Í≥µÏùÑ Íµ¥Î†§ Í≤∞ÏäπÏÑ†Ïóê Î®ºÏ†Ä ÎèÑÎã¨Ìïú Î™®Îë†Ïù¥ Î∞úÌëúÌï¥Ïöî.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="margin-top: 8px;">
            <!-- ÏÑ§Ï†ï/Ïª®Ìä∏Î°§ -->
            <div class="col s12 m4">
                <div class="card dark-card">
                    <div class="card-content">
                        <span class="card-title" style="color:#e5e7eb;">Î™®Îë† ÏÑ§Ï†ï</span>
                        <div class="row" style="margin-bottom: 8px;">
                            <div class="input-field col s12">
                                <input id="groupCountInput" type="number" min="2" max="8" value="4" class="validate" />
                                <label for="groupCountInput" class="active">Î™®Îë† Í∞úÏàò (2~8)</label>
                            </div>
                        </div>
                        <div class="row" style="margin-bottom: 8px;">
                            <div class="col s12" style="display:flex; gap:8px;">
                                <button id="buildLanesBtn" class="btn waves-effect" style="flex:1;">Í≤ΩÍ∏∞Ïû• ÏÉùÏÑ±</button>
                                <button id="startAllBtn" class="btn-secondary waves-effect" style="flex:1;">Ï†ÑÏ≤¥ ÏãúÏûë</button>
            </div>
        </div>
                        <div class="row">
                            <div class="col s12" style="display:flex; gap:8px;">
                                <button id="resetAllBtn" class="btn" style="flex:1;">Ï†ÑÏ≤¥ Ïû¨ÏãúÏûë</button>
                            </div>
                </div>
                        <div class="row" style="margin-top: 8px;">
                            <div class="col s12">
                                <span class="muted">Î™®Îë† Í∞úÏàòÎ•º Î≥ÄÍ≤ΩÌïòÎ©¥ Ï¶âÏãú Í≤ΩÍ∏∞Ïû•Ïù¥ Ïû¨ÏÉùÏÑ±Îê©ÎãàÎã§.</span>
                </div>
                    </div>
                    </div>
                </div>

                <div class="card dark-card">
                    <div class="card-content">
                        <span class="card-title" style="color:#e5e7eb;">Í≤∞Í≥º</span>
                        <ul id="leaderboard" class="collection" style="border-radius:16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);">
                            <li class="collection-item" style="background:transparent; color:#e5e7eb; border-bottom: 1px solid rgba(255,255,255,0.08);">Í∏∞Î°ùÌëúÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Í≤ΩÍ∏∞Ïû• -->
            <div class="col s12 m8">
                <div class="stadium">
                    <div class="stadium-content">
                        <div class="bunting">
                            <div class="flag"></div>
                            <div class="flag"></div>
                            <div class="flag"></div>
                            <div class="flag"></div>
                            <div class="flag"></div>
                </div>
                        <div id="winnerBanner">
                            <div class="winner-card">
                                <div class="winner-title">üèÜ Ïö∞Ïäπ! <span id="winnerName">Î™®Îë†</span></div>
                                <div class="winner-sub">Í∏∞Î°ù: <b id="winnerTime">0.00s</b> ‚Äî Î∞úÌëúÌï©ÎãàÎã§!</div>
                    </div>
                </div>
                        <div id="lanes"></div>
                        <div class="muted" style="margin-top: 8px;">TIP: Ï†ÑÏ≤¥ ÏãúÏûëÏùÑ ÎàÑÎ•¥Î©¥ Î™®Îë†Îì§Ïù¥ ÏûêÎèôÏúºÎ°ú Í≥µÏùÑ Íµ¥Î†§Ïöî. Ïã§Ï†ú Ïú°ÏÉÅ Ìä∏ÎûôÏ≤òÎüº Ìù∞ ÎùºÏù∏Í≥º Î†àÏù∏ Î≤àÌò∏Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.</div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
            
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Materialize AutoInit
            if (window.M && M.AutoInit) {
                M.AutoInit();
            }

            const emojis = ['üê∞','üêª','üêº','ü¶ä','üêØ','üêπ','üê®','üê∂'];
            const animals = [
                { code: '1f407', name: 'ÌÜ†ÎÅº' },
                { code: '1f43b', name: 'Í≥∞' },
                { code: '1f43c', name: 'ÌåêÎã§' },
                { code: '1f98a', name: 'Ïó¨Ïö∞' },
                { code: '1f42f', name: 'Ìò∏ÎûëÏù¥' },
                { code: '1f428', name: 'ÏΩîÏïåÎùº' },
                { code: '1f436', name: 'Í∞ïÏïÑÏßÄ' },
                { code: '1f431', name: 'Í≥†ÏñëÏù¥' }
            ];
            function animalSrcByIndex(i) {
                const a = animals[i % animals.length];
                return `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${a.code}.svg`;
            }
            const colors = [
                'linear-gradient(90deg, rgba(59,130,246,0.6), rgba(30,64,175,0.9))',
                'linear-gradient(90deg, rgba(16,185,129,0.6), rgba(5,150,105,0.9))',
                'linear-gradient(90deg, rgba(250,204,21,0.6), rgba(217,119,6,0.9))',
                'linear-gradient(90deg, rgba(244,114,182,0.6), rgba(190,24,93,0.9))',
                'linear-gradient(90deg, rgba(96,165,250,0.6), rgba(30,64,175,0.9))',
                'linear-gradient(90deg, rgba(167,139,250,0.6), rgba(109,40,217,0.9))',
                'linear-gradient(90deg, rgba(248,113,113,0.6), rgba(185,28,28,0.9))',
                'linear-gradient(90deg, rgba(52,211,153,0.6), rgba(6,95,70,0.9))'
            ];

            const groupCountInput = document.getElementById('groupCountInput');
            const buildLanesBtn = document.getElementById('buildLanesBtn');
            const startAllBtn = document.getElementById('startAllBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const lanes = document.getElementById('lanes');
            const leaderboard = document.getElementById('leaderboard');
            const winnerBanner = document.getElementById('winnerBanner');
            const winnerNameEl = document.getElementById('winnerName');
            const winnerTimeEl = document.getElementById('winnerTime');

            let laneState = []; // [{name, progress, elapsed, startTime, running, finished, speed, jitter, elements:{...}}]
            let winnerDeclared = false;
            let raceRAF = 0;

            function toast(msg) {
                if (window.M && M.toast) M.toast({ html: msg });
                else alert(msg);
            }

            function renderLeaderboard() {
                leaderboard.innerHTML = '';
                const finished = laneState.filter(l => l.finished);
                if (finished.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'collection-item';
                    li.style.background = 'transparent';
                    li.style.color = '#e5e7eb';
                    li.style.borderBottom = '1px solid rgba(255,255,255,0.08)';
                    li.textContent = 'Í∏∞Î°ùÌëúÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.';
                    leaderboard.appendChild(li);
                    return;
                }
                const sorted = finished.sort((a, b) => a.elapsed - b.elapsed);
                sorted.forEach((l, i) => {
                    const li = document.createElement('li');
                    li.className = 'collection-item';
                    li.style.background = 'transparent';
                    li.style.color = '#e5e7eb';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.style.borderBottom = '1px solid rgba(255,255,255,0.08)';
                    li.innerHTML = `<span>${i === 0 ? 'üèÜ ' : ''}${l.name}</span><span>${l.elapsed.toFixed(2)}s</span>`;
                    leaderboard.appendChild(li);
                });
            }

            function buildLanes() {
                const n = Math.max(2, Math.min(8, parseInt(groupCountInput.value || '4', 10)));
                lanes.innerHTML = '';
                laneState = [];
                winnerDeclared = false;
                // Hide winner banner and clear any previous winner styles
                if (winnerBanner) winnerBanner.style.display = 'none';
                for (let i = 0; i < n; i++) {
                    const lane = document.createElement('div');
                    lane.className = 'lane';

                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = emojis[i % emojis.length];

                    const trackWrap = document.createElement('div');
                    trackWrap.className = 'track';
                    const fill = document.createElement('div');
                    fill.className = 'track-fill';
                    fill.style.background = colors[i % colors.length];
                    const animal = document.createElement('div');
                    animal.className = 'animal';
                    const img = document.createElement('img');
                    img.src = animalSrcByIndex(i);
                    img.alt = 'animal';
                    animal.appendChild(img);
                    const ball = document.createElement('div');
                    ball.className = 'ball';
                    ball.style.left = '0%';
                    trackWrap.appendChild(fill);
                    trackWrap.appendChild(animal);
                    trackWrap.appendChild(ball);

                    const controls = document.createElement('div');
                    const meta = document.createElement('div');
                    meta.className = 'muted';
                    meta.style.marginBottom = '6px';
                    meta.innerHTML = `Î™®Îë† ${i + 1}`;
                    controls.appendChild(meta);
                    // removed AUTO chip

                    lane.appendChild(avatar);
                    lane.appendChild(trackWrap);
                    lane.appendChild(controls);
                    lanes.appendChild(lane);

                    laneState.push({
                        name: `Î™®Îë† ${i + 1}`,
                        progress: 0,
                        elapsed: 0,
                        startTime: 0,
                        running: false,
                        finished: false,
                        speed: 0,
                        jitter: 0,
                        elements: {
                            lane,
                            fill,
                            animal,
                            ball,
                            progressEl: null,
                            timeEl: null,
                            speedEl: null
                        }
                    });
                }
                renderLeaderboard();
                toast('Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÉùÏÑ±ÌñàÏñ¥Ïöî.');
            }

            function startAll() {
                if (laneState.length === 0) {
                    toast('Î®ºÏ†Ä Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÉùÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                winnerDeclared = false;
                // Hide banner and clear winner styles before starting
                if (winnerBanner) winnerBanner.style.display = 'none';
                laneState.forEach(l => {
                    if (l.elements && l.elements.lane) {
                        l.elements.lane.classList.remove('winner');
                    }
                });
                cancelAnimationFrame(raceRAF);
                const now = performance.now();
                // ÎûúÎç§ ÏÜçÎèÑ ÏÑ∏ÌåÖ (ÌçºÏÑºÌä∏/Ï¥à)
                // Ïòà: 18%/s ~ 32%/s + ÏÜåÌè≠ ÏßÄÌÑ∞
                laneState.forEach(l => {
                    l.progress = 0;
                    l.elapsed = 0;
                    l.startTime = now;
                    l.running = true;
                    l.finished = false;
                    l.speed = 18 + Math.random() * 14; // 18~32 %/s
                    l.jitter = 0.4 + Math.random() * 0.6; // 0.4~1.0 %/s Î≥ÄÎèôÌè≠
                    if (l.elements.speedEl) {
                        l.elements.speedEl.textContent = `${l.speed.toFixed(1)}%/s`;
                    }
                    renderLane(l);
                });
                renderLeaderboard();
                toast('Í≤ΩÍ∏∞ ÏãúÏûë! Î™®Îë†Îì§Ïù¥ ÏûêÎèôÏúºÎ°ú Í≥µÏùÑ Íµ¥Î¶ΩÎãàÎã§.');
                // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ ÏãúÏûë
                let last = now;
                function loop(ts) {
                    const dt = Math.max(0, Math.min(0.1, (ts - last) / 1000)); // clamp dt
                    last = ts;
                    if (!winnerDeclared) {
                        laneState.forEach(l => {
                            if (!l.running || l.finished) return;
                            // ÏÜçÎèÑ + ÏÜåÌè≠ ÎûúÎç§ ÏßÄÌÑ∞
                            const delta = (l.speed + (Math.random() * 2 - 1) * l.jitter) * dt;
                            l.progress += delta;
                            const nowT = ts;
                            l.elapsed = (nowT - l.startTime) / 1000;
                            if (l.progress >= 100) {
                                l.progress = 100;
                                l.finished = true;
                                l.running = false;
                                if (!winnerDeclared) {
                                    winnerDeclared = true;
                                    toast(`Ïö∞Ïäπ! ${l.name} (${l.elapsed.toFixed(2)}s) Î∞úÌëúÌï©ÎãàÎã§!`);
                                    renderLeaderboardWinnerOnly(l);
                                    if (l.elements.lane) {
                                        l.elements.lane.classList.add('winner');
                                        l.elements.lane.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                                    showWinnerBanner(l);
                                }
                            }
                            renderLane(l);
                        });
                    }
                    if (!winnerDeclared) {
                        raceRAF = requestAnimationFrame(loop);
                    }
                }
                raceRAF = requestAnimationFrame(loop);
            }

            function resetAll() {
                cancelAnimationFrame(raceRAF);
                laneState.forEach(l => {
                    l.progress = 0;
                    l.elapsed = 0;
                    l.running = false;
                    l.finished = false;
                    if (l.elements && l.elements.lane) {
                        l.elements.lane.classList.remove('winner');
                    }
                    renderLane(l);
                });
                winnerDeclared = false;
                renderLeaderboard();
                toast('Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å.');
                winnerBanner.style.display = 'none';
            }

            function renderLane(l) {
                const clamped = Math.max(0, Math.min(100, l.progress));
                l.elements.fill.style.width = clamped + '%';
                l.elements.ball.style.left = clamped + '%';
                if (l.elements.animal) {
                    const animalLeft = Math.max(0, clamped - 2);
                    l.elements.animal.style.left = animalLeft + '%';
                }
                if (l.elements.progressEl) l.elements.progressEl.textContent = clamped.toFixed(0) + '%';
                if (l.elements.timeEl) l.elements.timeEl.textContent = l.elapsed.toFixed(2) + 's';
            }

            function renderLeaderboardWinnerOnly(winnerLane) {
                leaderboard.innerHTML = '';
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.style.background = 'transparent';
                li.style.color = '#e5e7eb';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.borderBottom = '1px solid rgba(255,255,255,0.08)';
                li.innerHTML = `<span>üèÜ ${winnerLane.name}</span><span>${winnerLane.elapsed.toFixed(2)}s</span>`;
                leaderboard.appendChild(li);
            }
            function showWinnerBanner(winnerLane) {
                winnerNameEl.textContent = winnerLane.name;
                winnerTimeEl.textContent = `${winnerLane.elapsed.toFixed(2)}s`;
                // clear old confetti
                document.querySelectorAll('#winnerBanner .confetti').forEach(el => el.remove());
                // generate confetti
                const colors = ['#f59e0b','#60a5fa','#34d399','#f472b6','#fde047','#a78bfa'];
                for (let i = 0; i < 40; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = `${10 + Math.random() * 80}%`;
                    c.style.animationDelay = `${Math.random() * 0.6}s`;
                    c.style.background = colors[i % colors.length];
                    winnerBanner.appendChild(c);
                }
                winnerBanner.style.display = 'flex';
            }

            buildLanesBtn.addEventListener('click', () => {
                buildLanes();
            });
            startAllBtn.addEventListener('click', startAll);
            resetAllBtn.addEventListener('click', resetAll);
            // Auto-build on group count change
            groupCountInput.addEventListener('input', () => {
                buildLanes();
            });

            // Initial build
            buildLanes();
        });
    </script>
</body>
</html>